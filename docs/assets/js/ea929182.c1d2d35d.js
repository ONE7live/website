"use strict";(self.webpackChunkzfile_docs=self.webpackChunkzfile_docs||[]).push([[620],{2692:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>d,toc:()=>a});var s=o(7624),n=o(2172);const r={id:"node-not-ready",title:"Kosmos Node NotReady"},i="Kosmos Node NotReady",d={id:"v0.2.0/tutorials/node-not-ready",title:"Kosmos Node NotReady",description:"Kosmos Node NotReady Solution",source:"@site/docs/v0.2.0/tutorials/node-not-ready.md",sourceDirName:"v0.2.0/tutorials",slug:"/v0.2.0/tutorials/node-not-ready",permalink:"/website/v0.2.0/tutorials/node-not-ready",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/v0.2.0/tutorials/node-not-ready.md",tags:[],version:"current",lastUpdatedBy:"ONE7live",lastUpdatedAt:1709174921,formattedLastUpdatedAt:"Feb 29, 2024",frontMatter:{id:"node-not-ready",title:"Kosmos Node NotReady"},sidebar:"tutorialSidebar",previous:{title:"Multi-cluster Scheduler",permalink:"/website/v0.2.0/tutorials/mc-scheduler"},next:{title:"IPsec Cross-cluster Network",permalink:"/website/v0.2.0/tutorials/ipsec-network"}},l={},a=[{value:"Kosmos Node NotReady Solution",id:"kosmos-node-notready-solution",level:2},{value:"Introduction",id:"introduction",level:3},{value:"Solution",id:"solution",level:3},{value:"What is an admission webhook?",id:"what-is-an-admission-webhook",level:4},{value:"Kosmos Solution",id:"kosmos-solution",level:4}];function c(e){const t={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",p:"p",pre:"pre",...(0,n.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"kosmos-node-notready",children:"Kosmos Node NotReady"}),"\n",(0,s.jsx)(t.h2,{id:"kosmos-node-notready-solution",children:"Kosmos Node NotReady Solution"}),"\n",(0,s.jsx)(t.h3,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(t.p,{children:["Assuming that we have registered the cluster ",(0,s.jsx)(t.code,{children:"cluster7"})," on the master cluster:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",metastring:"script",children:"$ kubectl get node\r\nNAME               STATUS   ROLES                         AGE     VERSION\r\necs-54004033-001   Ready    worker                        50d     v1.21.5\r\necs-54004033-002   Ready    control-plane,master,worker   50d     v1.21.5\r\nkosmos-cluster7    Ready    agent                         5d22h   v1.21.5\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The clustertree-cluster-manager of Kosmos will continuously monitor the resource usage and cluster status of the ",(0,s.jsx)(t.code,{children:"cluster7"})," cluster, and update it to the leaf node ",(0,s.jsx)(t.code,{children:"kosmos-cluster7"})," on the master cluster."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",metastring:"script",children:"$ kubectl get deploy -nkosmos-system\r\nNAME                             READY   UP-TO-DATE   AVAILABLE   AGE\r\nclusterlink-controller-manager   1/1     1            1           5d22h\r\nclusterlink-elector              2/2     2            2           5d22h\r\nclusterlink-network-manager      1/1     1            1           5d22h\r\nclustertree-cluster-manager      1/1     1            1           5d22h\r\nkosmos-operator                  1/1     1            1           5d22h\r\nkosmos-webhook                   1/1     1            1           11\n"})}),"\n",(0,s.jsxs)(t.p,{children:["If there is a network fluctuation between the master cluster and the ",(0,s.jsx)(t.code,{children:"cluster7"})," cluster, Kosmos will detect this anomaly and set the status of the leaf node ",(0,s.jsx)(t.code,{children:"kosmos-cluster7"}),' on the master cluster to "not ready". This will trigger the pod eviction behavior in Kubernetes, meaning that the pods on the "not ready" node will be evicted to other ready nodes.']}),"\n",(0,s.jsxs)(t.p,{children:["However, due to network fluctuations, the status of ",(0,s.jsx)(t.code,{children:"kosmos-cluster7"}),' may become "ready" again during the eviction process. But the events of the originally evicted pods will still be sent to the "cluster7" cluster, causing normal running pods on the "cluster7" cluster to be deleted or restarted, thus affecting the business.']}),"\n",(0,s.jsx)(t.h3,{id:"solution",children:"Solution"}),"\n",(0,s.jsx)(t.h4,{id:"what-is-an-admission-webhook",children:"What is an admission webhook?"}),"\n",(0,s.jsx)(t.p,{children:'An "admission webhook" is a piece of code that intercepts requests to the Kubernetes API Server before object persistence. It allows requests to pass through after authentication and authorization. Admission controllers can perform validation, mutation, or both. Mutating controllers modify the resource objects they handle, while Validating controllers do not. If any controller in any phase rejects a request, the entire request will be immediately rejected, and the error will be returned to the end user.'}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"K8s_Admission_Webhook.png",src:o(9140).c+"",width:"2401",height:"721"})}),"\n",(0,s.jsx)(t.h4,{id:"kosmos-solution",children:"Kosmos Solution"}),"\n",(0,s.jsx)(t.p,{children:'We will create a ValidatingAdmissionWebhook controller specifically for the "DELETE Pod" event and when the nodeName is the Kosmos leaf node. When this node becomes "Not Ready," this controller will intercept the request, thereby stopping the pod eviction behavior of the API Server.'}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Kosmos_Admission_Webhook.png",src:o(6544).c+"",width:"1614",height:"748"})}),"\n",(0,s.jsx)(t.admonition,{title:"Note",type:"info",children:(0,s.jsx)(t.p,{children:"kosmos-webhook will be deployed as a separate controller in the master cluster."})})]})}function h(e={}){const{wrapper:t}={...(0,n.M)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},9140:(e,t,o)=>{o.d(t,{c:()=>s});const s=o.p+"assets/images/K8s_Admission_Webhook-d80e6ba8089fbf07bf3bf24a5302860a.png"},6544:(e,t,o)=>{o.d(t,{c:()=>s});const s=o.p+"assets/images/Kosmos_Admission_Webhook-6f617f75916da415e7547e6a4d827971.png"},2172:(e,t,o)=>{o.d(t,{I:()=>d,M:()=>i});var s=o(1504);const n={},r=s.createContext(n);function i(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);